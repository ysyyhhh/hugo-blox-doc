# Java--编译与解释共存的语言

[基本功 | Java即时编译器原理解析及实践](https://tech.meituan.com/2020/10/22/java-jit-practice-in-meituan.html)

编译型语言：
编译型语言是指在程序运行之前，需要先将源代码编译成机器码，然后再运行**编译后的机器码**。编译型语言有C、C++、Rust、Go等。

解释型语言：
解释型语言是指在程序运行时，需要通过解释器将源代码逐行解释成机器码，然后再运行机器码。解释型语言有Python、JavaScript、Ruby等。

而Java是一种编译与解释共存的语言，它的编译与解释过程如下：

1. 编译：Java源代码首先通过javac编译器**编译成字节码**（.class文件）。
2. 解释：然后通过Java虚拟机（JVM）将字节码解释成机器码，然后再运行机器码。

> 字节码(.class文件)：Java源代码经过编译后生成的中间代码，它不是机器码，而是一种介于源代码和机器码之间的代码。字节码可以在任何支持Java虚拟机的平台上运行，因此Java具有“一次编译，到处运行”的特性。

因此在性能上Java介于编译型语言和解释型语言之间，它的性能比解释型语言要好，但比编译型语言要差。

## 优化解释(即时编译 JIT, Just-In-Time Compilation)技术

为了优化性能,在第二步的解释中,Java使用了即时编译（JIT，Just-In-Time Compilation）技术


当程序运行时，解释器首先发挥作用，代码可以直接执行。随着时间推移，即时编译器逐渐发挥作用，把越来越多的代码编译优化成本地代码，来获取更高的执行效率。

即时编译器与静态编译相比:
- 可以选择热点代码进行编译，而不是整个程序
- 即时编译器已经非常成熟，可以进行更多的优化，比如内联、逃逸分析、栈上分配等

![](img/Java基础/Java程序变为机器码.png)


同样使用JIT技术的还有[LLVM](https://zh.wikipedia.org/zh-cn/LLVM)、V8引擎等。


> AOT: Ahead-Of-Time Compilation，预编译，是指在程序运行之前，将源代码编译成机器码(属于静态编译)。
> JDK 9引入了AOT编译器。
> AOT 避免了 JIT 预热等各方面的开销，可以提高 Java 程序的启动速度，避免预热时间长。并且，AOT 还能减少内存占用和增强 Java 程序的安全性（AOT 编译后的代码不容易被反编译和修改），特别适合云原生场景。

## AOT和JIT
![](img/Java基础/JITvsAOT.png)

AOT 的主要优势在于启动时间、内存占用和打包体积。
JIT 的主要优势在于具备更高的极限处理能力，可以降低请求的最大延迟。
> GraalVM 是一种高性能的 JDK（完整的 JDK 发行版本），它可以运行 Java 和其他 JVM 语言，以及 JavaScript、Python 等非 JVM 语言。 GraalVM 不仅能提供 AOT 编译，还能提供 JIT 编译。

AOT 更适合当下的云原生场景，对微服务架构的支持也比较友好。
但AOT 编译无法支持 Java 的一些动态特性，如反射、动态代理、动态加载、JNI（Java Native Interface）等。而很多框架和库（如 Spring、CGLIB）都用到了这些特性。为了支持类似的动态特性，所以选择使用 JIT 即时编译器。

> 如: CGLIB 动态代理使用的是 ASM 技术，而这种技术大致原理是运行时直接在内存中生成并加载修改后的字节码文件也就是 .class 文件，如果全部使用 AOT 提前编译，也就不能使用 ASM 技术了。

